/**
 * Scanner
 * v1.0.0
 * by Sarah Burnett
 */

class t{isCreated=!1;constructor(t){this.scanner=t,this.element=this.getOption("messageElement")??this.create(),this.getOption("displayMessage")||(this.element.style.display="none")}getOption(t){return this.scanner.getOption(t)}create(){if(this.isCreated)return;this.isCreated=!0;const t=document.createElement("div");return t.className=this.getOption("messageClassname"),this.getOption("parentElement").append(t),t}update(t,e=null){this.hide(),this.message=document.createElement("div"),this.message.className=this.getClassname(t),this.message.innerHTML=e||this.getMessage(t),this.element.append(this.message),this.display()}display(){this.message.style.display="block"}hide(){this.message&&(this.message.style.display="none"),this.element.innerHTML=""}getClassname(t){return t.toLowerCase()}getMessage(t){switch(t){case"SUCCESS":return this.getOption("successHTML");case"ERROR":return this.getOption("errorHTML");case"FAILED":return this.getOption("failedHTML");case"CANCELLED":return this.getOption("cancelledHTML");default:return this.getOption("scanningHTML")}}}class e{constructor(t){this.scan=t,this.type=t.state,this.result=t.result,this.error=t.error,this.scanner=t.getScanner(),this.message=t.getMessage(),this.onSuccess=this.getOption("handleSuccess"),this.onFailure=this.getOption("handleFailure"),this.onError=this.getOption("handleSuccess")}getOption(t){return this.scan.getOption(t)}async handle(){switch(this.type){case"SUCCESS":await this.handleSuccess(this.result);break;case"FAILED":await this.handleFailure(this.error);break;case"ERROR":await this.handleError(this.error)}}async handleSuccess(t){this.message.update(this.type),await this.onSuccess(t),this.scanner.stop()}async handleFailure(t){this.message.update(this.type),await this.onFailure(t)}async handleError(t){this.message.update(this.type),await this.onError(t),this.scanner.stop()}}class s{scannedImages=[];constructor(t){this.scanner=t,this.stream=t.stream,this.performScan=this.getOption("performScan")}getMessage(){return this.scanner.message}getScanner(){return this.scanner}getOption(t){return this.scanner.getOption(t)}isState(t){return this.state===t}setState(t){this.state=t}setResult(t){this.result=t}setError(t){this.error=t}prepare(){return this.stream.draw(),this.stream.blob((t=>this.addImage(t))),this.getLastImage()}async perform(t){await this.performScan(t);const s=new e(this);await s.handle()}addImage(t){this.scannedImages.push(t)}getLastImage(){return this.scannedImages.pop()}}class i{constructor(t){this.scanner=t,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.video=document.createElement("video"),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0}getOption(t){return this.scanner.getOption(t)}async start(){const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.getOption("videoFacingMode")}});this.video.srcObject=await t,await this.video.play()}async stop(){this.video.pause(),this.video.srcObject.getTracks().forEach((t=>t.stop())),this.video.srcObject=null}ready(){return this.video.readyState===this.video.HAVE_ENOUGH_DATA}draw(){this.canvas.height=this.video.videoHeight,this.canvas.width=this.video.videoWidth,this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.getOption("displayVideo")&&0==this.canvas.style.opacity&&(this.scanner.scanner.style.opacity=1,this.canvas.style.opacity=1)}blob(t){this.canvas.toBlob(t)}data(){return this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}line(t,e){this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.lineWidth=4,this.ctx.strokeStyle=this.getOption("primaryColor"),this.ctx.stroke()}hide(){this.canvas.style.opacity="0"}}class n{parentElement;position;performScan=()=>{};classname="scanner";iconHTML='<i class="fa fa-search"></i>';backBtnHTML="Go Back";videoFacingMode="environment";messageElement;messageClassname="scannerMessage";displayMessage=!0;displayVideo=!0;scanningHTML='<i class="fas fa-spinner"></i> Scanning';errorHTML='<i class="fas fa-exclamation-circle"></i> Scanning Error';successHTML='<i class="fas fa-check-circle"></i> Scanning Success';failedHTML='<i class="fas fa-exclamation-circle"></i> Scanning Failed';cancelledHTML='<i class="fas fa-exclamation-circle"></i> Scanning Cancelled';async handleSuccess(){}async handleFailure(){}async handleError(){}primaryColor="#03a803"}class a{options=new n;constructor(e){if(this.setOptions(e),!this.getOption("parentElement"))throw new Error("Need parent element to append created scanner");if(!this.getOption("position"))throw new Error("Need starting position for scanner");if(!this.getOption("performScan"))throw new Error("Need method for performing scan");this.message=new t(this)}setState(t){this.state=t}isState(t){return this.state===t}setOptions(t){for(let e in t)this.setOption(e,t[e])}setOption(t,e){this.options[t]=e}getOption(t){return this.options[t]}create(){this.scanner=document.createElement("div");const{top:t,left:e,width:n,height:a}=this.getOption("position");this.scanner.classList.add(this.getOption("classname")),this.scanner.style.position="fixed",this.scanner.style.top=t+"px",this.scanner.style.left=e+"px",this.scanner.style.width=n+"px",this.scanner.style.height=a+"px",this.icon=document.createElement("p"),this.icon.className="icon",this.iconTopBorder=document.createElement("div"),this.iconTopBorder.className="iconTopBorder",this.iconBottomBorder=document.createElement("div"),this.iconBottomBorder.className="iconBottomBorder",this.iconContent=document.createElement("div"),this.iconContent.innerHTML=this.getOption("iconHTML"),this.icon.append(this.iconTopBorder),this.icon.append(this.iconBottomBorder),this.icon.append(this.iconContent),this.backBtn=document.createElement("button"),this.backBtn.type="button",this.backBtn.id="backBtn",this.backBtn.innerHTML=this.getOption("backBtnHTML"),this.backBtn.addEventListener("click",(async()=>this.cancel())),this.stream=new i(this),this.scan=new s(this),this.scanner.appendChild(this.stream.canvas),this.scanner.appendChild(this.stream.video),this.scanner.appendChild(this.icon),this.scanner.appendChild(this.backBtn);this.getOption("parentElement").appendChild(this.scanner),this.setState("AVAILABLE")}async start(){this.scanner&&!this.isState("REMOVED")||this.create();try{await this.animateIn(),await this.stream.start(),this.setState("SCANNING"),await this.requestFrameScan()}catch(t){await this.error("Unable to start scanning")}}async stop(){this.isScanning()&&(this.setState("STOPPING"),await this.stream.stop()),await this.animateOut(),setTimeout((()=>this.message.hide()),2e3),this.scanner.remove(),this.setState("REMOVED")}async requestFrameScan(){return await this.requestAnimation(this.scanFrame.bind(this),20)}async scanFrame(){if(this.isScanning()){if(this.stream.ready()){const t=this.scan.prepare();await this.scan.perform(t)}await this.requestFrameScan()}}async cancel(){await this.stop(),this.message.update("CANCELLED")}async error(t){await this.stop(),this.message.update("ERROR",t)}isScanning(){return"SCANNING"===this.state}async animateIn(){const t="350",e=()=>{this.scanner.style.transition="\n                width 350ms ease-in-out,\n                height 350ms ease-in-out,\n                left 350ms ease-in-out,\n                top 350ms ease-in-out\n            ",this.scanner.style.zIndex="1000",this.scanner.style.opacity=1,this.scanner.style.top=0,this.scanner.style.left=0,this.scanner.style.width="100vw",this.scanner.style.height="100vh"};return new Promise((async s=>{await this.requestAnimation(e,t),this.scanner.classList.add("show"),this.backBtn.style.opacity="1",s()}))}async animateOut(){const t="350",e=this.getOption("position"),s=()=>{this.backBtn.style.opacity=1,this.stream.hide(),this.scanner.classList.remove("show"),this.scanner.style.transition="\n                width 350ms ease-in-out,\n                height 350ms ease-in-out,\n                left 350ms ease-in-out,\n                top 350ms ease-in-out\n            ",this.scanner.style.top=e.top+"px",this.scanner.style.left=e.left+"px",this.scanner.style.width=e.width+"px",this.scanner.style.height=e.height+"px"};return new Promise((async e=>{await this.requestAnimation(s,t),e()}))}requestAnimation(t,e){return new Promise((s=>{requestAnimationFrame(t),setTimeout(s,e)}))}}export{a as default};
